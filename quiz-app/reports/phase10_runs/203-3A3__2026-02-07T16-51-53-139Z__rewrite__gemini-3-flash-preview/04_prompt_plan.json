{
  "step": "plan",
  "model": "gemini-3-flash-preview",
  "temperature": 0,
  "maxTokens": 8000,
  "system": "You are an expert lesson JSON fix planner.\n\nYour task is to analyze scoring issues and create an explicit fix plan that classifies each issue by fixability and provides structured instructions.\n\nPHASE 10 INVARIANTS (CRITICAL):\n- Cannot add blocks\n- Cannot remove blocks\n- Cannot reorder blocks\n- Cannot change block.id, block.type, or block.order\n- Cannot change lesson.id, lesson.unit, lesson.topic, or lesson.layout\n- Block count must remain EXACTLY the same\n\nALLOWED OPERATIONS:\n- Edit content within existing blocks\n- Modify text fields (content, questionText, title, description, etc.)\n- Update expectedAnswer arrays\n- Modify hints\n- Change Bloom levels\n- Update learning outcomes\n- Add/edit/remove items in arrays within existing blocks (e.g., add vocab terms to existing vocab block, add questions to existing practice block)\n\nFIXABILITY CLASSIFICATIONS:\n\n1. \"deterministic\" - Mechanical fixes that follow a clear rule:\n   - Add missing \"Coming Up Next\" text\n   - Standardize formatting\n   - Fix consistent terminology issues\n\n2. \"llm_editable\" - Content improvements requiring judgment:\n   - Improve clarity of explanations\n   - Enhance question wording\n   - Add context or examples\n   - Improve hint quality\n\n3. \"blocked_by_policy\" - Conflicts with Phase 10 constraints:\n   - Issue requires answerType change (answerType changes are STRICTLY FORBIDDEN)\n   - Issue requires structural changes (add/remove/reorder blocks)\n   - Note the specific policy conflict\n\n4. \"requires_regeneration\" - Needs structural changes:\n   - Issue requires adding/removing entire blocks\n   - Needs reordering blocks\n   - Requires changing block types\n   - Fundamental restructuring of content\n   - NOTE: Adding items to arrays WITHIN existing blocks is allowed (vocab terms, learning outcomes, etc.)\n\nOUTPUT FORMAT:\n\nReturn ONLY valid JSON with this structure:\n\n{\n  \"plan\": [\n    {\n      \"issueId\": \"B1.orientation.preview\",\n      \"rubricRef\": \"B1\",\n      \"fixability\": \"llm_editable\",\n      \"targets\": [\"/blocks/3/content/content\"],\n      \"instructions\": \"Add 'In this lesson' preview section at start of explanation. Should describe what students will learn in 2-3 sentences.\",\n      \"guardrails\": [\"do not change block id or type\", \"preserve existing content\"],\n      \"textSnippets\": [\"### In this lesson\\n\\nYou will learn about...\"]\n    },\n    {\n      \"issueId\": \"B1.orientation.comingUpNext\",\n      \"rubricRef\": \"B1\",\n      \"fixability\": \"deterministic\",\n      \"targets\": [\"/blocks/9/content/notes\"],\n      \"instructions\": \"Append 'Coming Up Next: [Next Lesson Topic]' to notes field.\",\n      \"textSnippets\": [\" Coming Up Next: Circuit Protection and Overcurrent Devices.\"]\n    },\n    {\n      \"issueId\": \"D3.integrative.synthesis.format\",\n      \"rubricRef\": \"D3\",\n      \"fixability\": \"llm_editable\",\n      \"targets\": [\"/blocks/8/content/questions/1/questionText\", \"/blocks/8/content/questions/1/expectedAnswer\"],\n      \"instructions\": \"Add 'Answer in 3-4 sentences' to questionText; set expectedAnswer to key-points checklist (4-8 phrases covering main concepts to look for in student answer).\"\n    }\n  ]\n}\n\nRULES:\n- One plan item per scoring issue\n- Use JSON Pointer format for targets (e.g., \"/blocks/3/content/content\")\n- Be specific in instructions - explain WHAT to add/change and WHERE\n- For blocked issues, clearly state the policy conflict\n- Include guardrails for safety (e.g., \"preserve existing content\", \"do not change IDs\")\n- Optional textSnippets for deterministic fixes\n\n\nOUTPUT REQUIREMENTS:\n- Valid RFC 8259 JSON only (parseable by JSON.parse())\n- No markdown blocks, comments, or explanations\n- Double-quoted property names, no trailing commas\n- Return ONLY the JSON, nothing else",
  "user": "CREATE A FIX PLAN FOR THIS LESSON.\n\nLESSON METADATA:\n- ID: 203-3A3\n- Unit: Unit 203\n- Topic: Circuit Types: What They Do\n- Layout: split-vis\n- Block Count: 10 (MUST NOT CHANGE)\n\nBLOCK STRUCTURE (IMMUTABLE):\n  0: outcomes (id: 203-3A3-outcomes)\n  1: vocab (id: 203-3A3-vocab)\n  2: diagram (id: 203-3A3-diagram)\n  3: explanation (id: 203-3A3-explain-1)\n  4: practice (id: 203-3A3-check-1)\n  5: explanation (id: 203-3A3-explain-2)\n  6: practice (id: 203-3A3-check-2)\n  7: practice (id: 203-3A3-practice)\n  8: practice (id: 203-3A3-integrative)\n  9: spaced-review (id: 203-3A3-spaced-review)\n\nSCORING ISSUES:\nTotal Score: 88/100 (Usable)\n\nISSUE 1: beginnerClarityStaging: The lesson jumps from simple recall questions in the checks ...\n  Max Impact: 4 points\n  Problem: The lesson jumps from simple recall questions in the checks to high-level synthesis in the integrative block without a worked example or guided practice to model how to construct these complex answers.\n  Suggestions:\n    - Cannot be fixed by Phase 10 - requires regeneration\n  Affected Paths: /blocks/8, /blocks/9\n\nISSUE 2: markingRobustness: Expected answers for recall questions (e.g., 203-3A3-C1-L1-A...\n  Max Impact: 3 points\n  Problem: Expected answers for recall questions (e.g., 203-3A3-C1-L1-A) include redundant prompt text ('Final Circuit is defined as...'), which creates high friction for short-text matching.\n  Suggestions:\n    - Change blocks[4].content.questions[0].expectedAnswer from 'Final Circuit is defined as a circuit connected directly from a consumer unit or distribution board to current-using equipment,final circuit,final circuits' to 'final circuit,final circuits,a final circuit'\n    - Change blocks[4].content.questions[1].expectedAnswer from 'Control Circuit is specifically used to regulate or command the operation of other electrical equipment,control circuit,control circuits' to 'control circuit,control circuits,a control circuit'\n    - Change blocks[4].content.questions[2].expectedAnswer from 'Emergency Circuit must be designed to supply power to critical safety systems,emergency circuit,emergency circuits' to 'emergency circuit,emergency circuits,an emergency circuit'\n  Affected Paths: /blocks/4/content/questions/0/expectedAnswer, /blocks/4/content/questions/1/expectedAnswer, /blocks/4/content/questions/2/expectedAnswer, /blocks/6/content/questions/0/expectedAnswer, /blocks/6/content/questions/1/expectedAnswer, /blocks/6/content/questions/2/expectedAnswer\n\nISSUE 3: questions: Independent practice question P1 is virtually identical to c...\n  Max Impact: 3 points\n  Problem: Independent practice question P1 is virtually identical to check question C1-L1-A, providing no new context or application for the student to test their understanding.\n  Suggestions:\n    - Change blocks[7].content.questions[0].questionText from 'Identify the type of circuit that connects directly from a consumer unit or distribution board to current-using equipment.' to 'An electrician is wiring a dedicated feed for a new electric oven; what is the general term for this type of circuit connected directly from the consumer unit?'\n  Affected Paths: /blocks/7/content/questions/0/questionText\n\nISSUE 4: visual: The explanation blocks (4 and 6) do not explicitly reference...\n  Max Impact: 2 points\n  Problem: The explanation blocks (4 and 6) do not explicitly reference the diagram provided in block 3, missing an opportunity to anchor the text to the visual representation.\n  Suggestions:\n    - Modify blocks[3].content.content\n    - Modify blocks[5].content.content\n  Affected Paths: /blocks/3/content/content, /blocks/5/content/content\n\nISSUE 5: beginnerClarityStaging: Technical terms 'BS 7671' and 'Extra-low voltage (ELV)' are ...\n  Max Impact: 2 points\n  Problem: Technical terms 'BS 7671' and 'Extra-low voltage (ELV)' are introduced in the text but are missing from the Vocab block, which may confuse beginners.\n  Suggestions:\n    - Append to blocks[1].content.terms: '[object Object],[object Object]'\n  Affected Paths: /blocks/1/content/terms\n\nISSUE 6: questions: Connection-level questions at 203-3A3-C1-L2 and 203-3A3-C2-L...\n  Max Impact: 2 points\n  Problem: Connection-level questions at 203-3A3-C1-L2 and 203-3A3-C2-L2 lack formatting instructions (e.g., 'Answer in 1-2 sentences'), which can lead to overly brief or long-winded student responses.\n  Suggestions:\n    - Append to blocks[4].content.questions[3].questionText: ' (Answer in 2-3 sentences or concise bullet points.)'\n    - Append to blocks[6].content.questions[3].questionText: ' (Answer in 2-3 sentences or concise bullet points.)'\n  Affected Paths: /blocks/4/content/questions/3/questionText, /blocks/6/content/questions/3/questionText\n\n\n\nTASK:\nFor each scoring issue above, create a fix plan item that:\n1. Classifies fixability (deterministic / llm_editable / blocked_by_policy / requires_regeneration)\n2. Lists target JSON Pointer paths\n3. Provides clear, specific instructions\n4. Notes any guardrails or safety constraints\n5. For blocked issues, explains the policy conflict\n\nRemember:\n- Phase 10 CANNOT add/remove/reorder blocks\n- Phase 10 CANNOT change answerType (especially short-text â†’ long-text)\n- Phase 10 CAN edit content within blocks\n- Be explicit about what's fixable vs. what's blocked\n\nReturn ONLY the JSON plan object. No markdown, no additional text.",
  "inputRefs": [
    "00_input_lesson.json",
    "01_score_before.json"
  ],
  "notes": "Fix plan generation with fixability classification",
  "timestamp": "2026-02-07T16:52:22.922Z"
}