# C&G 2365 Quiz App - Current Implementation Documentation

Last verified: 2026-02-13
Status: Active implementation reference
Scope: Current code behavior only (not roadmap)

---

## 1. Purpose

This app is a Next.js learning platform for C&G 2365 content with:
- lesson delivery
- cumulative and diagnostic quiz flows
- learner progress and mastery tracking
- AI lesson and quiz generation pipelines
- admin microbreak game generation and insertion
- module-level planning/generation via Module Planner v6
- optional Supabase auth + server-side progress APIs

This document reflects the code currently in `src/`.

---

## 2. Tech Stack

From `package.json`:
- Next.js: `15.5.7`
- React / React DOM: `19.1.2`
- TypeScript: `^5`
- Tailwind CSS: `^4`
- LLM SDKs:
  - `@google/generative-ai ^0.24.1`
  - `@google-cloud/vertexai ^1.4.0`
- Auth/storage:
  - `@supabase/supabase-js`
- UI/utilities:
  - `canvas-confetti`
  - `lucide-react`
  - `uuid`
- Test runner: `vitest`

---

## 3. App Surface

### Pages

Implemented `page.tsx` routes:
- `/`
- `/learn`
- `/learn/[lessonId]`
- `/learn/[lessonId]/quiz`
- `/quiz`
- `/quiz/interleaved/[quizId]`
- `/generate`
- `/generate-quiz`
- `/admin/module`
- `/admin/generate-games`
- `/auth/sign-in`
- `/auth/callback`
- `/electron-simulation`
- `/test-generation`

### API routes

Implemented `route.ts` endpoints:
- `/api/lesson-generator`
- `/api/generate-quiz`
- `/api/admin/generate-games`
- `/api/admin/module/runs`
- `/api/admin/module/runs/:id`
- `/api/admin/module/:id/m0-distill`
- `/api/admin/module/:id/m1-analyze`
- `/api/admin/module/:id/m2-coverage`
- `/api/admin/module/:id/m3-plan`
- `/api/admin/module/:id/m4-blueprints`
- `/api/admin/module/:id/m5-validate`
- `/api/admin/module/:id/m6-generate`
- `/api/v1/attempts`
- `/api/v1/progress/lesson-start`
- `/api/v1/progress/lesson-complete`
- `/api/v1/progress/lesson/:lessonId`
- `/api/v1/review/wrong-items`
- `/api/lessons`
- `/api/lessons-status`
- `/api/delete-lesson`
- `/api/improve-lesson` (currently disabled, returns HTTP 501)
- `/api/tutor`
- `/api/chat`
- `/api/marking`
- `/api/score-lesson`
- `/api/diagnostic-analysis`
- `/api/questions/variant`
- `/api/upload-image`

---

## 4. Content Corpus

Current local corpus in repo:
- Lesson JSON files in `src/data/lessons`: 41
- Quiz/question source files (`*Questions.ts`) in `src/data/questions`: 46
- Available lesson index entries (`available: true`) in `src/data/lessons/lessonIndex.ts`: 40

---

## 5. Learning Experience Runtime

### Lesson index (`/learn`)

- The page imports lesson JSON files statically and builds `RAW_LESSONS`.
- Duplicate lesson IDs are removed at runtime in development with warning logs.
- Lessons are sorted by natural lesson ID order.
- Lessons are grouped by unit sections (201-204) in the UI.
- Review dashboard is shown at top (`ReviewDashboard`).
- Lesson card state badges are driven by quiz progress:
  - `masteryAchieved`
  - `masteryPending`

### Dynamic lesson page (`/learn/[lessonId]`)

- Lesson registry is static in `src/app/learn/[lessonId]/page.tsx`.
- Layout selection currently maps as:
  - `split-vis` -> `LayoutA`
  - all other layout values -> `LayoutB`
- `LayoutC` exists in code but is not selected by this route.
- If `lesson.diagnostic?.enabled` is true, lesson content is wrapped in `DiagnosticGate`.

### Diagnostic gate behavior

Diagnostic is a soft gate, not a hard lock:
- Diagnostic questions come from cumulative question service with:
  - `getCumulativeQuestions(lessonId, 10, 0.0)`
  - effectively 10 questions from previous lessons in the same unit
- Pass threshold comes from lesson diagnostic config (`diagnostic.passThreshold`).
- Pass is stored in localStorage key pattern: `diagnostic-pass-{lessonId}`.
- If learner fails, they can still proceed via "proceed anyway" path.

### Layout behavior

`LayoutA` and `LayoutB`:
- render block streams by `block.type`
- support `microbreak` block rendering through `MicrobreakBlock`
- include tutor panel integration
- include cumulative quiz CTA (`?mode=cumulative`)
- surface mastery state with `MasteryGate`

### Quiz behavior

Lesson quiz page (`/learn/[lessonId]/quiz`) configures `Quiz` with:
- `enableConfidence=true`
- `enableImmediateFeedback=true`
- `enableTypedRetries=true`
- `context="lesson"`

`Quiz` component behavior includes:
- randomized question selection count (user chooses from allowed counts)
- option shuffling per question
- confidence capture per answer
- immediate correctness feedback mode
- misconception surfacing when mappings exist
- typed retry section (`TypedRetrySection`) for wrong answers
- per-question attempt writes to IndexedDB (`saveAttempt`)
- needs-review priority updates in IndexedDB (`updateNeedsReview`)

---

## 6. Progress and Mastery

Progress is client-side and local-first, with optional server-side auth progress.

### Local storage

- Main progress storage key: `cg2365-learning-progress`
- Service: `src/lib/progress/progressService.ts`
- Migration/version support via `migrationService`

### Mastery model

For quizzes and lessons, mastery is delayed:
- First successful pass sets `masteryPending = true`
- Review/retest is scheduled (`nextReviewAt`)
- Later pass confirms `masteryAchieved = true`
- Failure during pending window resets pending mastery

### Additional local stores

- IndexedDB database: `quizTracking`
  - store: `attempts`
  - store: `needsReview`
- Microbreak telemetry localStorage key: `microbreak-telemetry`

### Optional server-side auth progress (`AUTH_PROGRESS_ENABLED=true`)

Protected endpoints under `/api/v1/*` support:
- attempt logging (`/api/v1/attempts`)
- lesson start/complete progress (`/api/v1/progress/*`)
- review queue (`/api/v1/review/wrong-items`)

Full operator usage is documented in `reports/app_des/sign_in.md`.

---

## 7. Microbreak System (Runtime)

### Block model

`microbreak` is a first-class block type in lesson schema.

Supported game types:
- `matching`
- `sorting`
- `spot-error`
- `tap-label`
- `quick-win`

### Rendering

`MicrobreakBlock` routes to game/rest components by `content.breakType` and `content.gameType`.

### Telemetry

On complete/skip, telemetry logs:
- lesson id
- break id/type
- optional game type
- timestamps
- optional score/accuracy

### Celebration/audio

`celebrationEffects.ts` currently uses:
- success: `/sounds/correct.mp3`
- failure: `/sounds/wrong.mp3`
- click: `/sounds/click.mp3`

Confetti/celebration variants implemented: 10.

---

## 8. Generation Pipeline

## 8.1 Lesson generation API

Endpoint: `/api/lesson-generator`

High-level server flow:
1. Environment validation
2. Rate limit check (global in-memory limiter)
3. Lesson generation via `FileGenerator`
4. Lesson validation
5. Quiz generation (50 questions target)
6. Quiz validation
7. File writes
8. Integration updates (`FileIntegrator`)
9. Optional git commit/push (`GitService`)

Rate limit config:
- `5` requests per hour per identifier (IP/header fallback)

Integration updates include key files such as:
- `src/data/questions/index.ts`
- `src/data/questions.ts`
- `src/data/lessons/lessonIndex.ts`
- `src/app/learn/[lessonId]/page.tsx`
- `src/app/learn/page.tsx`

## 8.2 Sequential lesson generation internals

Core orchestrator: `SequentialLessonGenerator`

Content phases:
1. Planning
2. Vocabulary
3. Explanation
4. Understanding checks
5. Worked example (conditional)
6. Practice
7. Integration
8. Spaced review
9. Assembly

Refinement/scoring phases:
- Phase 10: score
- Phase 12: refine full lesson JSON (`Phase12_Refine`)
- Phase 13: rescore and choose best

Current acceptance behavior is best-of comparison:
- keep candidate if score improves (or ties with fewer issues)
- else keep original

Important: runtime still contains legacy patch-era naming in metadata/log fields (for compatibility), even though active path is full-JSON refine/rescore.

## 8.3 Improve endpoint status

`/api/improve-lesson` is disabled and returns HTTP 501 with explicit message.

The `/generate` UI still includes improve controls that call this endpoint, but backend currently rejects requests.

---

## 9. Module Planner v6 (`/admin/module`)

Module Planner is additive and isolated from lesson pipeline internals.

### Operator flow

1. Open `/admin/module`
2. If disabled banner appears, set `MODULE_PLANNER_ENABLED=true`
3. Choose `Unit`
4. Optional `Selected LOs` as comma list (example: `LO1, LO5`)
5. Enter `Chat Transcript` (your planning intent text)
6. Optional `Notes`
7. Set constraints:
- `Max lessons / LO`
- `Ordering` (`foundation-first` or `lo-order`)
- `Level`
- `Audience`
8. Click `Create Run`
9. Run stages in order:
- Distill
- Analyze
- Extract Coverage
- Plan
- Build Blueprints
- Validate
- Generate
10. Review per-stage JSON cards and final Run Summary

### Interface details

- `Replay-from-artifacts` checkbox enables deterministic replay by `request_hash`
- Stage button `*` means replay artifact exists for that stage/hash
- `Stop` cancels the current browser request only (does not force-cancel server work)
- Top right `Lesson` button links back to `/generate`

### Prompts/instructions involved

- Module Planner does not currently send freeform prompts to an LLM in M0-M6.
- It uses deterministic parsing/planning logic over local syllabus chunks.
- User-entered `Chat Transcript` and `Notes` are used as planning input data for distill/config, not as direct model prompts.

Detailed endpoint/payload examples and stage contracts are in `reports/app_des/module_planner.md`.

---

## 10. Sign-In and Auth Tracking

### Sign-in UI (`/auth/sign-in`)

- Magic-link email sign-in via Supabase (`signInWithOtp`)
- Shows signed-in email state
- Supports sign-out
- Redirect target for successful auth is `/auth/callback?next=/learn`

### Callback UI (`/auth/callback`)

- Completes auth using `token_hash/type` or `code`
- Validates safe redirect (`next` must start with `/`)
- Redirects to `/learn` by default

### Prompts/instructions involved

- No LLM prompts are used in sign-in/auth flows.
- These are direct Supabase auth/session flows.

Full setup, request formats, and troubleshooting are in `reports/app_des/sign_in.md`.

---

## 11. LLM Client Architecture

Abstraction: `src/lib/llm/client.ts`

Provider options:
- Google AI Studio
- Vertex AI

Behavior:
- `createLLMClientWithFallback()` tries Vertex when configured
- falls back to Google AI Studio on init failure

This abstraction is used by multiple APIs/services including:
- tutor/chat routes
- marking
- scoring
- generation internals

---

## 12. Known Drift / Technical Debt (Observed)

The current runtime works, but naming/history drift exists:
- Legacy patch-oriented phase files remain on disk:
  - `Phase11_Suggest.ts`
  - `Phase12_Implement.ts`
- Legacy patch-oriented tests still exist in `src/lib/generation/__tests__/phase10-13-pipeline.test.ts`
- Runtime types/comments/logs still use fields like `patchesApplied` and patch-oriented wording.
- Some config comments still reference the old Phase 11/12 patch flow.

This drift is documentation-relevant and should be treated as compatibility residue, not active runtime architecture.

---

## 13. Quick File Map

Core learning pages:
- `src/app/learn/page.tsx`
- `src/app/learn/[lessonId]/page.tsx`
- `src/app/learn/[lessonId]/quiz/page.tsx`

Layout/rendering:
- `src/components/learning/layouts/LayoutA.tsx`
- `src/components/learning/layouts/LayoutB.tsx`
- `src/components/learning/layouts/LayoutC.tsx`
- `src/components/learning/DiagnosticGate.tsx`
- `src/components/Quiz.tsx`

Progress and storage:
- `src/lib/progress/progressService.ts`
- `src/lib/progress/migrationService.ts`
- `src/lib/storage/indexedDBService.ts`

Generation:
- `src/app/api/lesson-generator/route.ts`
- `src/lib/generation/fileGenerator.ts`
- `src/lib/generation/SequentialLessonGenerator.ts`
- `src/lib/generation/phases/*`
- `src/lib/generation/fileIntegrator.ts`

Module planner:
- `src/app/admin/module/page.tsx`
- `src/app/api/admin/module/*`
- `src/lib/module_planner/*`
- `reports/app_des/module_planner.md`

Auth + server progress:
- `src/app/auth/sign-in/page.tsx`
- `src/app/auth/callback/page.tsx`
- `src/app/api/v1/*`
- `src/lib/supabase/*`
- `src/lib/authProgress/*`
- `reports/app_des/sign_in.md`

Admin microbreak generation:
- `src/app/admin/generate-games/page.tsx`
- `src/components/admin/GameGeneratorForm.tsx`
- `src/app/api/admin/generate-games/route.ts`
- `src/lib/generation/gameGenerator.ts`
- `src/components/learning/microbreaks/MicrobreakBlock.tsx`

---

This document supersedes older architecture descriptions that referenced now-disabled improve API behavior or patch-based active runtime flow.
